# 需求文档

## 介绍

本项目旨在开发一个国际化的签证和居留申请状态自动查询系统，采用前后端分离架构，支持多用户的Web界面管理和托管查询服务。系统采用模块化插件架构，便于扩展到不同国家的移民局查询页面，并提供多种通知方式（Telegram、邮件、Web通知等）来及时通知用户申请状态变化。

## 需求

### 需求 1：多国家查询支持

**用户故事：** 作为系统管理员，我希望系统能够支持多个国家的签证/居留申请状态查询，以便为不同国家的用户提供服务。

#### 验收标准

1. WHEN 系统启动时 THEN 系统 SHALL 支持通过二位国家代码（ISO 3166-1 alpha-2）标识不同国家
2. WHEN 添加新国家支持时 THEN 系统 SHALL 通过插件化模块实现，无需修改核心代码
3. WHEN 查询特定国家状态时 THEN 系统 SHALL 根据国家代码调用相应的查询插件
4. WHEN 国家插件不存在时 THEN 系统 SHALL 记录错误日志并跳过该查询

### 需求 2：用户管理和认证

**用户故事：** 作为用户，我希望能够注册账户并安全地管理我的申请信息，以便保护个人隐私。

#### 验收标准

1. WHEN 新用户访问系统时 THEN 系统 SHALL 提供用户注册功能
2. WHEN 用户注册时 THEN 系统 SHALL 验证用户名和邮箱的唯一性
3. WHEN 用户登录时 THEN 系统 SHALL 验证凭据并提供JWT令牌
4. WHEN 用户访问受保护资源时 THEN 系统 SHALL 验证令牌有效性
5. WHEN 用户会话过期时 THEN 系统 SHALL 要求重新登录

### 需求 3：申请配置管理

**用户故事：** 作为用户，我希望通过Web界面配置多个被查询者的信息，以便同时监控多个申请状态。

#### 验收标准

1. WHEN 用户创建申请时 THEN 系统 SHALL 通过Web表单允许配置国家码、被查询者标识、查询代码和查询方式
2. WHEN 用户配置申请时 THEN 系统 SHALL 支持为每个申请设置独立的通知方式和查询间隔
3. WHEN 用户未设置个人参数时 THEN 系统 SHALL 使用全局默认设置
4. WHEN 用户配置多个申请时 THEN 系统 SHALL 支持每个用户最多10个申请的配置
5. WHEN 保存配置时 THEN 系统 SHALL 在前端和后端都验证配置格式的正确性
6. WHEN 用户编辑申请时 THEN 系统 SHALL 提供直观的Web界面进行修改

### 需求 4：通知系统

**用户故事：** 作为用户，我希望在申请状态发生变化时能够及时收到通知，以便了解申请进展。

#### 验收标准

1. WHEN 系统检测到状态变化时 THEN 系统 SHALL 立即发送通知到指定通道
2. WHEN 首次查询时 THEN 系统 SHALL 发送当前状态的初始通知
3. WHEN 状态未变化时 THEN 系统 SHALL 每天发送一次当前状态摘要
4. WHEN 通知方式设置为None时 THEN 系统 SHALL 仅记录到日志文件
5. WHEN 通知发送失败时 THEN 系统 SHALL 记录错误并在下次查询时重试
6. IF 设置了全局通知方式 THEN 系统 SHALL 支持Telegram、邮件、Web通知和None四种方式
7. IF 用户设置了个人通知方式 THEN 系统 SHALL 优先使用个人设置
8. WHEN 状态更新时 THEN 系统 SHALL 通过WebSocket实时推送到Web界面

### 需求 5：查询调度系统

**用户故事：** 作为系统管理员，我希望系统能够自动按照设定的时间间隔执行查询，避免对目标网站造成过大压力。

#### 验收标准

1. WHEN 系统执行查询时 THEN 系统 SHALL 支持分钟(m)、小时(h)、天(d)、周(w)的时间间隔设置
2. WHEN 有多个被查询者时 THEN 系统 SHALL 在每次查询间添加1分钟内的随机延迟
3. WHEN 全局查询间隔设置为1小时时 THEN 系统 SHALL 作为默认查询频率
4. WHEN 用户设置个人查询间隔时 THEN 系统 SHALL 优先使用个人设置
5. WHEN 系统启动时 THEN 系统 SHALL 根据配置自动开始调度查询任务

### 需求 6：Web界面功能

**用户故事：** 作为用户，我希望通过直观的Web界面管理我的申请和查看状态，以便方便地使用系统。

#### 验收标准

1. WHEN 用户访问系统时 THEN 系统 SHALL 提供响应式的Web界面，支持桌面和移动设备
2. WHEN 用户登录后 THEN 系统 SHALL 显示仪表板，包含所有申请的状态概览
3. WHEN 用户查看申请列表时 THEN 系统 SHALL 显示每个申请的当前状态和最后更新时间
4. WHEN 用户点击申请时 THEN 系统 SHALL 显示详细的状态历史记录
5. WHEN 状态发生变化时 THEN 系统 SHALL 通过WebSocket实时更新界面
6. WHEN 用户设置通知时 THEN 系统 SHALL 提供测试通知功能
7. WHEN 用户选择语言时 THEN 系统 SHALL 支持中文和英文界面切换
8. WHEN 系统显示内容时 THEN 系统 SHALL 根据用户选择的语言显示相应的文本

### 需求 7：数据持久化

**用户故事：** 作为系统管理员，我希望系统能够可靠地存储用户数据和查询历史，以便提供稳定的服务。

#### 验收标准

1. WHEN 系统启动时 THEN 系统 SHALL 支持SQLite本地存储或MySQL数据库
2. WHEN 用户数据发生变化时 THEN 系统 SHALL 确保数据的一致性和完整性
3. WHEN 系统重启时 THEN 系统 SHALL 保持所有用户配置和历史数据
4. WHEN 数据库连接失败时 THEN 系统 SHALL 记录错误并提供降级服务
5. WHEN 数据量增长时 THEN 系统 SHALL 支持数据清理和归档功能

### 需求 8：日志记录系统

**用户故事：** 作为系统管理员，我希望系统能够详细记录所有操作和状态变化，以便进行问题排查和系统监控。

#### 验收标准

1. WHEN 系统执行任何操作时 THEN 系统 SHALL 记录详细的操作日志
2. WHEN 创建日志文件时 THEN 系统 SHALL 在文件名中包含当天日期
3. WHEN 通知方式设置为None时 THEN 系统 SHALL 将查询结果记录到日志文件
4. WHEN 发生错误时 THEN 系统 SHALL 记录错误详情和堆栈信息
5. WHEN 日志文件过大时 THEN 系统 SHALL 支持日志轮转功能

### 需求 9：API和配置管理

**用户故事：** 作为开发者，我希望系统提供完整的RESTful API和灵活的配置管理，以便进行集成和定制。

#### 验收标准

1. WHEN 系统启动时 THEN 系统 SHALL 提供完整的RESTful API文档
2. WHEN API被调用时 THEN 系统 SHALL 返回标准的JSON响应格式
3. WHEN 系统配置时 THEN 系统 SHALL 支持环境变量和配置文件两种方式
4. WHEN 配置错误时 THEN 系统 SHALL 在启动时显示详细的错误信息
5. WHEN API发生错误时 THEN 系统 SHALL 返回标准的HTTP状态码和错误信息
6. IF 配置包含敏感信息 THEN 系统 SHALL 支持环境变量配置

### 需求 10：捷克移民局查询实现

**用户故事：** 作为用户，我希望系统能够查询捷克移民局的签证申请状态，作为第一个实现的国家插件。

#### 验收标准

1. WHEN 查询捷克(CZ)申请状态时 THEN 系统 SHALL 访问https://ipc.gov.cz/en/status-of-your-application/
2. WHEN 提交查询请求时 THEN 系统 SHALL 使用visa application number (ŽOV)格式的查询码
3. WHEN 解析查询结果时 THEN 系统 SHALL 提取申请状态信息
4. WHEN 网站结构发生变化时 THEN 系统 SHALL 记录解析错误并通知管理员
5. WHEN 网站不可访问时 THEN 系统 SHALL 记录连接错误并在下次调度时重试

### 需求 11：国际化和多语言支持

**用户故事：** 作为国际用户，我希望系统能够支持我的母语界面，以便更好地理解和使用系统功能。

#### 验收标准

1. WHEN 用户首次访问系统时 THEN 系统 SHALL 根据浏览器语言设置自动选择界面语言
2. WHEN 用户切换语言时 THEN 系统 SHALL 立即更新所有界面文本为选定语言
3. WHEN 系统显示日期和时间时 THEN 系统 SHALL 根据用户语言设置使用相应的格式
4. WHEN 系统发送通知时 THEN 系统 SHALL 使用用户选择的语言发送通知内容
5. WHEN 开发者添加新语言时 THEN 系统 SHALL 支持通过语言文件扩展新语言
6. WHEN 用户选择语言时 THEN 系统 SHALL 持久化保存用户的语言偏好
7. IF 某个文本没有对应语言翻译 THEN 系统 SHALL 显示英文作为后备语言
8. WHEN 系统初始化时 THEN 系统 SHALL 支持中文（简体）和英文两种语言

### 需求 12：项目结构和文档

**用户故事：** 作为开发者，我希望项目具有清晰的结构和完整的文档，以便进行二次开发和社区贡献。

#### 验收标准

1. WHEN 项目初始化时 THEN 系统 SHALL 提供清晰的前后端分离目录结构
2. WHEN 开发者查看项目时 THEN 系统 SHALL 包含完整的README文档和API文档
3. WHEN 开发者需要添加新国家支持时 THEN 系统 SHALL 提供插件开发指南
4. WHEN 用户部署系统时 THEN 系统 SHALL 提供Docker容器化部署方案
5. WHEN 项目发布时 THEN 系统 SHALL 包含开源许可证和贡献指南
6. WHEN 开发者进行前端开发时 THEN 系统 SHALL 提供组件文档和开发指南
7. WHEN 开发者需要添加新语言时 THEN 系统 SHALL 提供国际化开发指南